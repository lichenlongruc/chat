<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智谱清言 AI 聊天助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .typing {
      border-right: 2px solid #3b82f6;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50% { border-color: transparent; }
      51%, 100% { border-color: #3b82f6; }
    }
    .thought-chain {
      background-color: #f3f4f6;
      border-left: 3px solid #9ca3af;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      color: #4b5563;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4">
    <h1 class="text-2xl font-bold text-center text-blue-600">智谱清言 AI 聊天助手</h1>
  </header>

  <main class="flex-1 overflow-y-auto p-4 max-w-3xl mx-auto w-full">
    <div id="message-container" class="space-y-4">
      <!-- 消息会动态插入这里 -->
    </div>
  </main>

  <footer class="bg-white border-t p-4">
    <form id="chat-form" class="flex gap-2">
      <input
        type="text"
        id="user-input"
        placeholder="输入您的问题..."
        class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        autocomplete="off"
      />
      <button
        type="submit"
        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition"
      >
        发送
      </button>
    </form>
  </footer>

  <script>
    const messageContainer = document.getElementById('message-container');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    let messageCount = 0;

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = userInput.value.trim();
      if (!input) return;

      addMessage('user', input);
      userInput.value = '';

      const loadingId = addMessage('bot', '正在思考中...', true);
      try {
        const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer 7b5c7afb6f54726077a539c7d2a0b764.JOFYYlJJoYmJc6pJ`, // 替换成你的 API Key
          },
          body: JSON.stringify({
            model: 'glm-z1-flash',
            messages: [{ role: 'user', content: input }],
            stream: false,
            temperature: 0.7,
          }),
        });

        const data = await response.json();
        const content = data.choices?.[0]?.message?.content || '出错了，请稍后再试。';
        const thoughtChain = data.choices?.[0]?.message?.thought_chain || '';

        updateMessage(loadingId, content, thoughtChain);
      } catch (err) {
        updateMessage(loadingId, '请求失败，请检查网络或 API 配置。');
        console.error(err);
      }
    });

    function addMessage(role, content, isLoading = false, thoughtChain = '') {
      const id = `msg-${messageCount++}`;
      const isUser = role === 'user';
      const messageHtml = `
        <div id="${id}" class="flex ${isUser ? 'justify-end' : 'justify-start'}">
          <div class="max-w-xs md:max-w-md lg:max-w-lg bg-white rounded-lg shadow p-4 ${isUser ? 'bg-blue-100' : ''}">
            <div class="font-medium ${isUser ? 'text-blue-800' : 'text-gray-800'}">${isUser ? '你' : 'AI'}</div>
            <div class="mt-1 text-gray-700">${content}</div>
            ${!isUser && !isLoading ? `
              <button class="toggle-thought-chain mt-2 text-sm text-gray-500 hover:text-gray-700" data-target="${id}-chain">
                <i class="fas fa-chevron-down mr-1"></i>查看思维链
              </button>
              <div id="${id}-chain" class="thought-chain hidden">${thoughtChain}</div>
            ` : ''}
          </div>
        </div>
      `;
      messageContainer.insertAdjacentHTML('beforeend', messageHtml);
      messageContainer.scrollTop = messageContainer.scrollHeight;
      return id;
    }

    function updateMessage(id, content, thoughtChain = '') {
      const messageEl = document.getElementById(id);
      if (!messageEl) return;

      const contentEl = messageEl.querySelector('.text-gray-700');
      if (contentEl) contentEl.innerHTML = content;

      if (thoughtChain) {
        const chainId = `${id}-chain`;
        const toggleBtn = `
          <button class="toggle-thought-chain mt-2 text-sm text-gray-500 hover:text-gray-700" data-target="${chainId}">
            <i class="fas fa-chevron-down mr-1"></i>查看思维链
          </button>
          <div id="${chainId}" class="thought-chain hidden">${thoughtChain}</div>
        `;
        messageEl.querySelector('.bg-white').insertAdjacentHTML('beforeend', toggleBtn);
      }

      attachToggleListeners();
    }

    function attachToggleListeners() {
      document.querySelectorAll('.toggle-thought-chain').forEach(btn => {
        btn.removeEventListener('click', toggleThoughtChain);
        btn.addEventListener('click', toggleThoughtChain);
      });
    }

    function toggleThoughtChain(e) {
      const targetId = e.currentTarget.getAttribute('data-target');
      const chainEl = document.getElementById(targetId);
      const icon = e.currentTarget.querySelector('i');

      if (chainEl.classList.contains('hidden')) {
        chainEl.classList.remove('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        e.currentTarget.innerHTML = '<i class="fas fa-chevron-up mr-1"></i>收起思维链';
      } else {
        chainEl.classList.add('hidden');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        e.currentTarget.innerHTML = '<i class="fas fa-chevron-down mr-1"></i>查看思维链';
      }
    }
  </script>
</body>
</html>
